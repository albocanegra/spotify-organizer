<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify Artist Organizer</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Music, Grid3x3, Plus, Trash2, ExternalLink } = lucide;

    const SpotifyOrganizer = () => {
      const [accessToken, setAccessToken] = useState(null);
      const [artists, setArtists] = useState([]);
      const [categories, setCategories] = useState({
        'Uncategorized': []
      });
      const [loading, setLoading] = useState(false);
      const [newCategoryName, setNewCategoryName] = useState('');
      const [showNewCategory, setShowNewCategory] = useState(false);

      const CLIENT_ID = 'e21bf88870a94703bc0cdcf317075a5e';
      const REDIRECT_URI = 'https://albocanegra.github.io/spotify-organizer';
      const SCOPES = 'user-follow-read';

      useEffect(() => {
        const hash = window.location.hash;
        if (hash) {
          const token = new URLSearchParams(hash.substring(1)).get('access_token');
          if (token) {
            setAccessToken(token);
            window.location.hash = '';
            fetchFollowedArtists(token);
          }
        }

        const saved = localStorage.getItem('spotifyCategories');
        if (saved) {
          setCategories(JSON.parse(saved));
        }
      }, []);

      const handleLogin = () => {
        const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
        window.location.href = authUrl;
      };

      const fetchFollowedArtists = async (token) => {
        setLoading(true);
        try {
          let allArtists = [];
          let url = 'https://api.spotify.com/v1/me/following?type=artist&limit=50';

          while (url) {
            const response = await fetch(url, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            allArtists = [...allArtists, ...data.artists.items];
            url = data.artists.next;
          }

          setArtists(allArtists);
          
          const categorizedIds = new Set();
          Object.values(categories).forEach(cat => {
            cat.forEach(id => categorizedIds.add(id));
          });

          const uncategorized = allArtists
            .filter(a => !categorizedIds.has(a.id))
            .map(a => a.id);

          if (uncategorized.length > 0) {
            const updated = {
              ...categories,
              'Uncategorized': [...(categories.Uncategorized || []), ...uncategorized]
            };
            setCategories(updated);
            localStorage.setItem('spotifyCategories', JSON.stringify(updated));
          }
        } catch (error) {
          console.error('Error fetching artists:', error);
        }
        setLoading(false);
      };

      const addCategory = () => {
        if (newCategoryName.trim() && !categories[newCategoryName]) {
          const updated = { ...categories, [newCategoryName]: [] };
          setCategories(updated);
          localStorage.setItem('spotifyCategories', JSON.stringify(updated));
          setNewCategoryName('');
          setShowNewCategory(false);
        }
      };

      const deleteCategory = (categoryName) => {
        if (categoryName === 'Uncategorized') return;
        const { [categoryName]: deleted, ...rest } = categories;
        const updated = {
          ...rest,
          'Uncategorized': [...rest.Uncategorized, ...deleted]
        };
        setCategories(updated);
        localStorage.setItem('spotifyCategories', JSON.stringify(updated));
      };

      const moveArtist = (artistId, fromCategory, toCategory) => {
        const updated = { ...categories };
        updated[fromCategory] = updated[fromCategory].filter(id => id !== artistId);
        updated[toCategory] = [...updated[toCategory], artistId];
        setCategories(updated);
        localStorage.setItem('spotifyCategories', JSON.stringify(updated));
      };

      const getArtistById = (id) => artists.find(a => a.id === id);

      if (!accessToken) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-green-900 via-black to-black flex items-center justify-center p-4">
            <div className="bg-gray-900 rounded-lg p-8 max-w-md w-full text-center shadow-2xl">
              <Music className="w-16 h-16 text-green-500 mx-auto mb-4" />
              <h1 className="text-3xl font-bold text-white mb-2">Spotify Artist Organizer</h1>
              <p className="text-gray-400 mb-6">Organize your followed artists into custom categories</p>
              
              <div className="bg-gray-800 border border-gray-700 rounded p-4 mb-6 text-left text-sm">
                <p className="text-gray-300 mb-2">Connect your Spotify account to start organizing your followed artists into custom categories.</p>
                <p className="text-gray-400 text-xs">Your data is stored locally in your browser.</p>
              </div>

              <button
                onClick={handleLogin}
                className="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-full transition"
              >
                Connect with Spotify
              </button>
            </div>
          </div>
        );
      }

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-green-900 via-black to-black flex items-center justify-center">
            <div className="text-center">
              <Music className="w-12 h-12 text-green-500 mx-auto mb-4 animate-pulse" />
              <p className="text-white">Loading your artists...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-green-900 via-black to-black p-4">
          <div className="max-w-6xl mx-auto">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <Music className="w-8 h-8 text-green-500" />
                <h1 className="text-2xl font-bold text-white">My Artist Library</h1>
                <span className="bg-green-500 text-black px-3 py-1 rounded-full text-sm font-semibold">
                  {artists.length} artists
                </span>
              </div>
              <button
                onClick={() => setShowNewCategory(!showNewCategory)}
                className="bg-green-500 hover:bg-green-600 text-black font-semibold py-2 px-4 rounded-full flex items-center gap-2"
              >
                <Plus className="w-4 h-4" />
                New Category
              </button>
            </div>

            {showNewCategory && (
              <div className="bg-gray-900 rounded-lg p-4 mb-6 flex gap-2">
                <input
                  type="text"
                  value={newCategoryName}
                  onChange={(e) => setNewCategoryName(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && addCategory()}
                  placeholder="Category name (e.g., Rock, Jazz, Electronic...)"
                  className="flex-1 bg-gray-800 text-white px-4 py-2 rounded border border-gray-700 focus:border-green-500 outline-none"
                />
                <button
                  onClick={addCategory}
                  className="bg-green-500 hover:bg-green-600 text-black font-semibold px-4 py-2 rounded"
                >
                  Add
                </button>
                <button
                  onClick={() => setShowNewCategory(false)}
                  className="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded"
                >
                  Cancel
                </button>
              </div>
            )}

            <div className="space-y-6">
              {Object.entries(categories).map(([categoryName, artistIds]) => {
                const categoryArtists = artistIds.map(id => getArtistById(id)).filter(Boolean);
                
                return (
                  <div key={categoryName} className="bg-gray-900 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-2">
                        <Grid3x3 className="w-5 h-5 text-green-500" />
                        <h2 className="text-xl font-bold text-white">{categoryName}</h2>
                        <span className="text-gray-400 text-sm">({categoryArtists.length})</span>
                      </div>
                      {categoryName !== 'Uncategorized' && (
                        <button
                          onClick={() => deleteCategory(categoryName)}
                          className="text-red-400 hover:text-red-300 p-1"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      )}
                    </div>

                    {categoryArtists.length === 0 ? (
                      <p className="text-gray-500 text-sm italic">No artists in this category</p>
                    ) : (
                      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                        {categoryArtists.map(artist => (
                          <div key={artist.id} className="bg-gray-800 rounded-lg p-3 group hover:bg-gray-750">
                            <img
                              src={artist.images[0]?.url || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect fill="%23374151" width="100" height="100"/%3E%3C/svg%3E'}
                              alt={artist.name}
                              className="w-full aspect-square object-cover rounded mb-2"
                            />
                            <p className="text-white font-semibold text-sm mb-1 truncate">{artist.name}</p>
                            <div className="flex gap-1 mb-2">
                              
                                href={artist.external_urls.spotify}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="flex-1 bg-green-500 hover:bg-green-600 text-black text-xs py-1 px-2 rounded flex items-center justify-center gap-1"
                              >
                                <ExternalLink className="w-3 h-3" />
                                Open
                              </a>
                            </div>
                            <select
                              value={categoryName}
                              onChange={(e) => moveArtist(artist.id, categoryName, e.target.value)}
                              className="w-full bg-gray-700 text-white text-xs py-1 px-2 rounded border border-gray-600 outline-none"
                            >
                              {Object.keys(categories).map(cat => (
                                <option key={cat} value={cat}>{cat}</option>
                              ))}
                            </select>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SpotifyOrganizer />);
  </script>
</body>
</html>
